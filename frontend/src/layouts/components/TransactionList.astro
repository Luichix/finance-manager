---
import TransactionCard from "@/components/TransactionCard";
import Transactions from "@/services/Transactions";
import { cleanParams } from "@/utils/queryParams";
import { type ITransaction } from "@/interfaces/Transactions";
// import Paginate from '@/layouts/components/Paginate.astro';
// import config from '@/config/config.json';

export const prerender = false;

const searchParams = Astro.url.searchParams;

const formatDate = searchParams.get("date");
const allParams = {
  type: searchParams.get("type"),
  limit: searchParams.get("limit"),
  date: formatDate && new Date(formatDate).toISOString(),
  offset: searchParams.get("offset"),
};

const getTransactions = new Transactions().fetchPaginatedData;

const params = cleanParams(allParams);

const data = await getTransactions(params);

const { limit, offset, ...restParams } = params;

// const getAllTransactions = await getTransactions(restParams);

// const itemsPerPage = parseInt(limit) || config.settings.pagination;

// const totalPages = Math.ceil(getAllTransactions.length / itemsPerPage);

const totalData = (data: ITransaction[]) => {
  const incomeTotal = data
    .filter((item) => item.type == "INCOME")
    .map((item) => item.amount)
    .reduce((previous, current) => previous + current, 0);
  const outcomeTotal = data
    .filter((item) => item.type == "OUTCOME")
    .map((item) => item.amount)
    .reduce((previous, current) => previous + current, 0);

  data.sort((a: ITransaction, b: ITransaction) => {
    const first = new Date(a.createdAt).getTime();
    const second = new Date(b.createdAt).getTime();
    return first - second;
  });

  const groupedByDate = data.reduce(
    (accumulate: Record<string, ITransaction[]>, transaction: ITransaction) => {
      const date = new Date(transaction.createdAt).toISOString().slice(0, 10);

      if (!accumulate[date]) {
        accumulate[date] = [];
      }

      accumulate[date].push(transaction);

      return accumulate;
    },
    {},
  );

  const listByDate = Object.entries(groupedByDate).map(
    ([date, transactions]) => {
      const incomeTotal = transactions
        .filter((item) => item.type == "INCOME")
        .map((item) => item.amount)
        .reduce((previous, current) => previous + current, 0);
      const outcomeTotal = transactions
        .filter((item) => item.type == "OUTCOME")
        .map((item) => item.amount)
        .reduce((previous, current) => previous + current, 0);
      return {
        date,
        transactions,
        incomeTotal,
        outcomeTotal,
      };
    },
  );

  return {
    incomeTotal,
    outcomeTotal,
    total: incomeTotal + outcomeTotal,
    transactions: listByDate,
  };
};

const transactions = totalData(data);
---

<div class="bg-white">
  <div class="flex justify-between items-center px-8 py-4">
    <div class="flex flex-col items-center text-lg text-gray-500">
      <span>Ingresos</span>
      <span class="text-xl font-bold text-[#477beb]"
        >$ {transactions.incomeTotal.toFixed(2)}</span
      >
    </div>
    <div class="flex flex-col items-center text-lg text-gray-500">
      <span>Egresos</span>
      <span class="text-xl font-bold text-[#f35252]">
        $ {transactions.outcomeTotal.toFixed(2)}</span
      >
    </div>
    <div class="flex flex-col items-center text-lg text-gray-500">
      <span>Total</span>
      <span class="text-xl font-bold text-black"
        >$ {transactions.total.toFixed(2)}</span
      >
    </div>
  </div>
  {
    transactions.transactions &&
      transactions.transactions.map((item) => {
        const date = new Date(item.date).getUTCDate();
        const period = new Date(item.date).toLocaleDateString("es-ES", {
          month: "short",
        });
        const month = new Date(item.date).toLocaleDateString("es-ES", {
          month: "2-digit",
        });
        const year = new Date(item.date).toLocaleDateString("es-ES", {
          year: "2-digit",
        });

        return (
          <>
            <div class="mt-4 flex justify-between items-center px-8 py-4 bg-gray-200 rounded-md">
              <div class="flex gap-2 items-center">
                <span class="text-3xl font-bold">{date}</span>
                <span class="bg-secondary-900 text-white font-bold text-md px-2 py-0 rounded-md first-letter:uppercase">
                  {period}
                </span>
                <span class="text-md text-gray-500">
                  {month}.{year}
                </span>
              </div>
              <div class="flex gap-16 items-center">
                <span class="text-lg font-bold text-[#477beb]">
                  $ {item.incomeTotal.toFixed(2)}
                </span>
                <span class="text-lg font-bold text-[#f35252]">
                  $ {item.outcomeTotal.toFixed(2)}
                </span>
              </div>
            </div>
            {item.transactions &&
              item.transactions.map((transaction: ITransaction) => (
                <TransactionCard client:load {...transaction} />
              ))}
          </>
        );
      })
  }
</div>
<!-- <div class="pt-10">
  <Paginate currentPage={1} totalPages={totalPages} />
</div> -->

<!-- <script>
  const select = document.getElementById('select-items') as HTMLSelectElement;
  const date = document.getElementById('select-date') as HTMLSelectElement;
  const type = document.getElementById('select-type') as HTMLSelectElement;
  const clean = document.getElementById('clean-select') as HTMLButtonElement;

  if (select) {
    select.addEventListener('change', function (event: Event) {
      const selectedValue = (event.target as HTMLSelectElement).value;
      const currentUrl = window.location.href;
      const url = new URL(currentUrl);

      url.searchParams.set('limit', selectedValue);
      window.location.href = url.toString();
    });
  }
  if (type) {
    type.addEventListener('change', function (event: Event) {
      const selectedValue = (event.target as HTMLSelectElement).value;
      const currentUrl = window.location.href;
      const url = new URL(currentUrl);

      url.searchParams.set('type', selectedValue);
      window.location.href = url.toString();
    });
  }
  if (date) {
    date.addEventListener('change', function (event: Event) {
      const selectedValue = (event.target as HTMLInputElement).value;
      const currentUrl = window.location.href;
      const url = new URL(currentUrl);

      url.searchParams.set('date', selectedValue);
      window.location.href = url.toString();
    });
  }
  if (clean) {
    clean.addEventListener('click', function () {
      const currentUrl = window.location.href;
      const url = new URL(currentUrl);
      url.search = '';
      window.location.href = url.toString();
    });
  }
</script> -->
